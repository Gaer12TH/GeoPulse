/**
 * Wake Lock Utility
 * Combines Screen Wake Lock API with Video Loop Fallback
 * Ported from index.html logic
 */

let noSleepVideo = null;
let wakeLockSentinel = null;

const BASE64_VIDEO = 'data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAACQG1kYXQAAAKAYXZjQwAAAAQAAgACABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAABZtZWF0AAACAAQAAgAAAAEAQAAAAAAAZ2xibssADwAAAAAABAAAAABtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAAKAABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAGGlvZHMAAAAAEICAgAcAT////3//AAACQHRyYWsAAABcdGtoZAAAAAIAAAAAAAAAAAAAAAPoAAAAKAAAAAAAAAAAAAAAAAEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAThtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAAPoAAAAKAAAAAAHAABoZGxyAAAAAAAAAAB2aWRlAAAAAAAAAAAAAAAAVmlkZW8gHGFuZGxlcgAAAB5taW5mAAAAFHZtaGQAAAAAAQAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAABMHN0YmwAAACwc3RzZAAAAAAAAAABAAAALG1wNHYAAAAAAAAAAQAAAAEAAAABAAAAAAACAEAAAAAoAAAAAAADAAAAIHN0dHMAAAAAAAAAAQAAAAkAAAAKAAAAAQAAACRzdHNzAAAAAAAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAABxjdHRzAAAAAAAAAAkAAAAKAAAAAAAACQAAABhzdHNjAAAAAAAAAAIAAAABAAAABAAAAAEAAAACAAAABQAAAAEAAAAwc3RzZAAAAAAAAAABAAAALAAAAGQ=';

export async function enableWakeLock() {
    // 1. Try Native Wake Lock API
    try {
        if ('wakeLock' in navigator) {
            wakeLockSentinel = await navigator.wakeLock.request('screen');
            console.log('Screen Wake Lock active');
        }
    } catch (err) {
        console.warn('Wake Lock API failed:', err);
    }

    // 2. Video Fallback
    try {
        if (!noSleepVideo) {
            noSleepVideo = document.createElement('video');
            noSleepVideo.setAttribute('playsinline', '');
            noSleepVideo.setAttribute('loop', '');
            noSleepVideo.setAttribute('muted', '');
            noSleepVideo.src = BASE64_VIDEO;
            noSleepVideo.style.display = 'none';
            document.body.appendChild(noSleepVideo);
        }
        await noSleepVideo.play();
        console.log('NoSleep video playing');
    } catch (e) {
        console.warn('NoSleep video failed:', e);
    }
}

export function disableWakeLock() {
    // 1. Release Native Wake Lock
    if (wakeLockSentinel) {
        wakeLockSentinel.release()
            .then(() => {
                wakeLockSentinel = null;
                console.log('Wake Lock released');
            });
    }

    // 2. Stop Video
    if (noSleepVideo) {
        noSleepVideo.pause();
        console.log('NoSleep video paused');
    }
}
